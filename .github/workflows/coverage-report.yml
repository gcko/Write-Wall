name: Coverage Report

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

env:
  COVERAGE_THRESHOLD: "1.0"

jobs:
  coverage:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      pull-requests: write
      actions: read

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Get PR number
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr view --repo "${{ github.repository }}" \
            "${{ github.event.workflow_run.head_repository.owner.login }}:${{ github.event.workflow_run.head_branch }}" \
            --json 'number' --jq '.number' 2>/dev/null || echo "")

          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
            echo "Using fallback PR number from workflow_run"
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "::error::Could not determine PR number"
            exit 1
          fi

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER"

      # Download base branch coverage (from latest master push)
      - name: Download base coverage
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          workflow: ci.yml
          branch: master
          name: coverage-main
          path: ./base-coverage/

      # Download PR branch coverage (Node 22 artifact from the triggering run)
      - name: Download PR coverage
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: coverage-node-22-${{ github.event.workflow_run.id }}
          path: ./pr-coverage/

      - name: Ensure coverage files exist
        run: |
          mkdir -p base-coverage pr-coverage
          [ -f base-coverage/coverage-final.json ] || echo '{}' > base-coverage/coverage-final.json
          [ -f pr-coverage/coverage-final.json ] || echo '{}' > pr-coverage/coverage-final.json

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v47
        with:
          separator: ','

      - name: Generate coverage report
        id: report
        run: |
          node scripts/coverage-report.cjs \
            --base base-coverage/coverage-final.json \
            --pr pr-coverage/coverage-final.json \
            --changed-files "${{ steps.changed.outputs.all_changed_files }}" \
            --threshold ${{ env.COVERAGE_THRESHOLD }} \
            --base-path "$(pwd)/" \
            --output coverage-report.md
        continue-on-error: true

      - name: Find existing comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          body-includes: "<!-- coverage-report-marker -->"

      - name: Post PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body-path: coverage-report.md
          edit-mode: replace
